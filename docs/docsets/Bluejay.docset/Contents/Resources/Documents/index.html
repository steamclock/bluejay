<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bluejay  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Bluejay  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Bluejay Docs</a> (90% documented)</p>
        <p class="header-right"><a href="https://github.com/steamclock/bluejay"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Bluejay Reference</a>
        <img id="carat" src="img/carat.png" />
        Bluejay  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Bluejay.html">Bluejay</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Peripheral.html">Peripheral</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/BackgroundRestoreMode.html">BackgroundRestoreMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ConnectionResult.html">ConnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DisconnectionResult.html">DisconnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ListenAction.html">ListenAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ReadResult.html">ReadResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RunResult.html">RunResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ScanAction.html">ScanAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/WriteResult.html">WriteResult</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/CBManagerState.html">CBManagerState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheral.html">CBPeripheral</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheralState.html">CBPeripheralState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBService.html">CBService</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Data.html">Data</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Integer.html">Integer</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/String.html">String</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/ConnectionObserver.html">ConnectionObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ListenRestorer.html">ListenRestorer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RSSIObserver.html">RSSIObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Receivable.html">Receivable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Sendable.html">Sendable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/CharacteristicIdentifier.html">CharacteristicIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DataPadding.html">DataPadding</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PeripheralIdentifier.html">PeripheralIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ScanDiscovery.html">ScanDiscovery</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ServiceIdentifier.html">ServiceIdentifier</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <p><img src="https://raw.githubusercontent.com/steamclock/bluejay/master/bluejay-wordmark.png" alt="Bluejay"></p>

<p><img src="https://img.shields.io/cocoapods/v/Bluejay.svg" alt="CocoaPods Compatible">
<img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible">
<a href="http://cocoadocs.org/docsets/Bluejay"><img src="https://img.shields.io/cocoapods/p/Bluejay.svg?style=flat" alt="Platform"></a>
<a href=""><img src="https://img.shields.io/github/license/mashape/apistatus.svg" alt="license"></a></p>

<p>Bluejay is a simple Swift framework for building reliable Bluetooth LE apps.</p>

<p>Bluejay&rsquo;s primary goals are:</p>

<ul>
<li>Simplify talking to a single Bluetooth LE peripheral</li>
<li>Make it easier to handle Bluetooth operations reliably</li>
<li>Take advantage of Swift features and conventions</li>
</ul>
<h2 id='index' class='heading'>Index</h2>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#usage">Usage</a>

<ul>
<li><a href="#initialization">Initialization</a></li>
<li><a href="#bluetooth-events">Bluetooth Events</a></li>
<li><a href="#services-and-characteristics">Services and Characteristics</a></li>
<li><a href="#scanning">Scanning</a></li>
<li><a href="#connecting">Connecting</a></li>
</ul></li>
<li><a href="#deserialization-and-serialization">Deserialization and Serialization</a>

<ul>
<li><a href="#receivable">Receivable</a></li>
<li><a href="#sendable">Sendable</a></li>
</ul></li>
<li><a href="#interactions">Interactions</a>

<ul>
<li><a href="#reading">Reading</a></li>
<li><a href="#writing">Writing</a></li>
<li><a href="#listening">Listening</a></li>
<li><a href="#batch-operations">Batch Operations</a></li>
</ul></li>
<li><a href="#background-operation">Background Operation</a>

<ul>
<li><a href="#state-restoration">State Restoration</a></li>
<li><a href="#listen-restoration">Listen Restoration</a></li>
</ul></li>
<li><a href="#advanced-usage">Advanced Usage</a>

<ul>
<li><a href="#connect-by-serial-number">Connect by Serial Number</a></li>
<li><a href="#write-and-assemble">Write and Assemble</a></li>
<li><a href="#flush-listen">Flush Listen</a></li>
</ul></li>
</ul>
<h2 id='features' class='heading'>Features</h2>

<ul>
<li>A callback-based API</li>
<li>A FIFO operation queue for more synchronous and predictable behaviour</li>
<li>A background task mode for batch operations that avoids the <q>callback pyramid of death</q></li>
<li>Simple protocols for data serialization and deserialization</li>
<li>An easy and safe way to observe connection states</li>
<li>Listen restoration</li>
<li>Extended error handling</li>
</ul>
<h2 id='requirements' class='heading'>Requirements</h2>

<ul>
<li>iOS 9.3 or above</li>
<li>Xcode 8.2.1 or above</li>
<li>Swift 3.2 or above</li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>

<p>Install using CocoaPods:</p>

<p><code>pod &#39;Bluejay&#39;, &#39;~&gt; 0.1&#39;</code></p>

<p>Or to try the latest master:</p>

<p><code>pod &#39;Bluejay&#39;, :git =&gt; &#39;https://github.com/steamclock/bluejay.git&#39;, :branch =&gt; &#39;master&#39;</code></p>

<p>Cartfile:</p>

<p><code>github &quot;steamclock/bluejay&quot; ~&gt; 0.1</code></p>

<p>Import using:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Bluejay</span>
</code></pre>
<h2 id='demo' class='heading'>Demo</h2>

<p>The iOS Simulator does not simulate Bluetooth. You may not have a Bluetooth LE peripheral handy, so we recommend trying Bluejay using a BLE peripheral simulator such as the <a href="https://itunes.apple.com/ca/app/lightblue-explorer-bluetooth/id557428110?mt=8">LightBlue Explorer App</a>.</p>

<p>Bluejay has a demo app called <strong>BluejayDemo</strong> that works with LightBlue Explorer. To see it in action:</p>

<ol>
<li>Get two iOS devices â€“ one to run a BLE peripheral simulator, and the other to run the Bluejay demo app.</li>
<li>On one iOS device, go to the App Store and download LightBlue Explorer.</li>
<li>Launch LightBlue Explorer, and tap on the <strong>Create Virtual Peripheral</strong> button located at the bottom of the peripheral list.</li>
<li>To start, choose <strong>Heart Rate</strong> from the base profile list, and finish by tapping the <strong>Save</strong> button.</li>
<li>Finally, build and run <strong>BluejayDemo</strong> on the other iOS device. Once it launches, choose <strong>Heart Rate Sensor</strong> in the menu, and you will be able to start interacting with the virtual heart rate peripheral.</li>
</ol>

<p><strong>Notes:</strong></p>

<ul>
<li>You can turn the virtual peripheral on or off in LightBlue Explorer by tapping the blue circle to the left of the peripheral&rsquo;s name.

<ul>
<li>If the virtual peripheral is not working as expected, you can try to reset it this way.</li>
</ul></li>
<li>The virtual peripheral may use your iPhone or iPad name, because the virtual peripheral is an extension of the host device.</li>
<li>Some characteristics in the various virtual peripherals available in LightBlue Explorer might not have read of write permissions enabled by default, but you can change most of those settings.

<ul>
<li>After selecting your virtual peripheral, tap on the characteristic you wish to modify, then tap on either the <q>Read</q> or <q>Write</q> property to customize their permissions.</li>
<li>Characteristics belonging to the Device Information service, for example, are read only.</li>
</ul></li>
</ul>
<h2 id='usage' class='heading'>Usage</h2>
<h3 id='initialization' class='heading'>Initialization</h3>

<p>Create an instance of Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">bluejay</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="p">()</span>
</code></pre>

<p>While you may want to create one Bluejay instance and use it everywhere, you can also create instances in specific portions of your app and tear them down after use. It&rsquo;s worth noting, however, that each instance of Bluejay has its own <a href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanager">CBCentralManager</a>, which makes the multi-instance approach somewhat more complex.</p>

<p>Once you&rsquo;ve created an instance, you can start the <a href="https://developer.apple.com/documentation/corebluetooth">Core Bluetooth</a> session. You can do this during initialization of your app or view controller, as appropriate. For example, in the demo app Bluejay is started inside <code>viewDidLoad</code> of the root view controller.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>

<p>Bluejay needs to be started explicitly in order to support Core Bluetooth&rsquo;s State Restoration. State Restoration restores the Bluetooth stack and state when your app is restored from the background.</p>

<p>If you want to support <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html#//apple_ref/doc/uid/TP40013257-CH7-SW1">Background Mode</a> and <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html#//apple_ref/doc/uid/TP40013257-CH7-SW10">State Restoration</a> in your app, <a href="#background-operation">it will take some extra work</a>, which is necessary for Bluetooth apps that do work in the background.</p>
<h3 id='bluetooth-events' class='heading'>Bluetooth Events</h3>

<p>The <code>ConnectionObserver</code> protocol allows a class to monitor and respond to major Bluetooth and connection-related events:</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ConnectionObserver</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">bluetoothAvailable</span><span class="p">(</span><span class="n">_</span> <span class="nv">available</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">connected</span><span class="p">(</span><span class="n">to</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">Peripheral</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">disconnected</span><span class="p">(</span><span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">Peripheral</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can register a <code>ConnectionObserver</code> when starting Bluejay:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">connectionObserver</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
</code></pre>

<p>Or you can add additional observers later using:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">observer</span><span class="p">:</span> <span class="n">batteryLabel</span><span class="p">)</span>
</code></pre>

<p>Unregistering an observer is not necessary, because Bluejay only holds weak references to registered observers. But if you need to do so, you can:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">unregister</span><span class="p">(</span><span class="nv">observer</span><span class="p">:</span> <span class="n">rssiLabel</span><span class="p">)</span>
</code></pre>
<h3 id='services-and-characteristics' class='heading'>Services and Characteristics</h3>

<p>In Bluetooth parlance, a Service is a group of attributes, and a Characteristic is an attribute belonging to a group. For example, BLE peripherals that can detect heart rates typically have a Service named <q>Heart Rate</q> with a UUID of <q>180D</q>. Inside that Service are Characteristics such as <q>Body Sensor Location</q> with a UUID of <q>2A38</q>, as well as <q>Heart Rate Measurement</q> with a UUID of <q>2A37</q>.</p>

<p>Many of these Services and Characteristics are standards specified by the Bluetooth SIG organization, and most hardware adopt their specifications. For example, most BLE peripherals implement the Service <q>Device Information</q> which has a UUID of <q>180A</q>, which is where Characteristics such as firmware version, serial number, and other hardware details can be found. Of course, there are many BLE uses not covered by the Bluetooth Core Spec, and custom hardware often have their own unique Services and Characteristics.</p>

<p>Here is how you can specify Services and Characteristics for use in Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bodySensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">heartRate</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A37"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
</code></pre>

<p>Bluejay uses the <code>ServiceIdentifier</code> and <code>CharacteristicIdentifier</code> structs to avoid problems like accidentally specifying a Service when a Characteristic is expected.</p>
<h3 id='scanning' class='heading'>Scanning</h3>

<p>Bluejay has a powerful device scanning API that can be be used simply or customized to satisfy many use cases.</p>
<h4 id='basic-scanning' class='heading'>Basic Scanning</h4>

<p>This simple call will just notify you when there is a new discovery, and when the scan has finished:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="p">[</span><span class="n">heartRateService</span><span class="p">],</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">stopped</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>A scan result <code>(ScanDiscovery, [ScanDiscovery])</code> contains the current discovery followed by an array of all the discoveries made so far.</p>

<p>The stopped result contains all the discoveries made, and an error if there is one.</p>
<h4 id='scan-action' class='heading'>Scan Action</h4>

<p>A <code>ScanAction</code> is returned at the end of a discovery callback to tell Bluejay whether to keep scanning or to stop.</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ScanAction</span> <span class="p">{</span>
    <span class="k">case</span> <span class="err">`</span><span class="k">continue</span><span class="err">`</span>
    <span class="k">case</span> <span class="n">blacklist</span>
    <span class="k">case</span> <span class="n">stop</span>
    <span class="k">case</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">ScanDiscovery</span><span class="p">,</span> <span class="p">(</span><span class="kt">ConnectionResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Returning <code>blacklist</code> will ignore any future discovery of the same peripheral within the current scan session. This is only useful when <code>allowDuplicates</code> is set to true.</p>

<p>Returning <code>connect</code> will first stop the current scan, and have Bluejay make your connection request. This is useful if you want to connect right away when you&rsquo;ve found the peripheral you&rsquo;re looking for. You can set up the <code>ConnectionResult</code> block outside the scan call to reduce callback nesting.</p>
<h4 id='monitoring' class='heading'>Monitoring</h4>

<p>Another useful way to use the scanning API is to monitor the RSSI changes of nearby peripherals to estimate their proximity:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">allowDuplicates</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">expired</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">lostDiscovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Lost discovery: </span><span class="se">\(</span><span class="n">lostDiscovery</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
<span class="p">})</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Key parameters here are <code>allowDuplicates</code> and <code>expired</code>.</p>

<p>Setting <code>allowDuplicates</code> to true will stop coalescing multiple discoveries of the same peripheral into one single discovery callback. Instead, you&rsquo;ll get a discovery call every time a peripheral&rsquo;s advertising packet is picked up. This will consume more battery, and does not work in the background.</p>

<p>The <code>expired</code> callback is only invoked when <code>allowDuplicates</code> is true. This is called when Bluejay estimates that a previously discovered peripheral is likely out of range or no longer broadcasting. Essentially, when <code>allowDuplicates</code> is set to true, every time a peripheral is discovered a long timer associated with that peripheral starts counting down. If that peripheral is within range, and even if it has a slow broadcasting interval, it is likely that peripheral will be picked up by Core Bluetooth again and cause the timer to refresh. If not, it may be gone. Be aware that this is an estimation.</p>

<p>Finally, passing <code>nil</code> for the service identifiers will result in picking up all available Bluetooth peripherals in the vicinity. This consumes substantially more battery, and again, does not work in the background.</p>
<h3 id='connecting' class='heading'>Connecting</h3>

<p>It is important to keep in mind that Bluejay is designed to work with a single BLE peripheral. Multiple connections at once is not currently supported, and a connection request will fail if Bluejay is already connected or is still connecting. Although this can be a limitation for some sophisticated apps, it is more commonly a safeguard to ensure your app does not issue connections unnecessarily or erroneously.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">peripheralIdentifier</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">peripheral</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> successful."</span><span class="p">)</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="nf">performSegue</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="s">"showHeartSensor"</span><span class="p">,</span> <span class="nv">sender</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To disconnect:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
</code></pre>

<p>Rarely, a disconnect request can fail or get cancelled, so it is generally a good idea to make use of the completion block to provide error handling.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="n">disconnect</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">peripheral</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> successful."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheralIdentifier</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuidString</span><span class="se">)</span><span class="s"> cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheralIdentifier</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuidString</span><span class="se">)</span><span class="s"> failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='connection-states' class='heading'>Connection States</h4>

<p>Your Bluejay instance has these properties to help you make connection-related decisions:</p>

<ul>
<li><code>isBluetoothAvailable</code></li>
<li><code>isConnecting</code></li>
<li><code>isConnected</code></li>
<li><code>isDisconnecting</code></li>
<li><code>isScanning</code></li>
</ul>
<h2 id='deserialization-and-serialization' class='heading'>Deserialization and Serialization</h2>

<p>Reading, writing, and listening to Characteristics is straightforward in Bluejay. Most of the work involved is building out the deserialization and serialization of data. Let&rsquo;s have a quick look at how Bluejay helps standardize this process in your app via the <code>Receivable</code> and <code>Sendable</code> protocols.</p>
<h4 id='receivable' class='heading'>Receivable</h4>

<p>The models that represent data you wish to read and receive from your peripheral should all conform to the <code>Receivable</code> protocol.</p>

<p>Here is a partial example for the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml">Heart Rate Measurement Characteristic</a>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">HeartRateMeasurement</span><span class="p">:</span> <span class="kt">Receivable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement8bits</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement16bits</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">energyExpended</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">rrInterval</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">isMeasurementIn8bits</span> <span class="o">=</span> <span class="kc">true</span>

    <span class="k">var</span> <span class="nv">measurement</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">isMeasurementIn8bits</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement8bits</span><span class="p">)</span> <span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement16bits</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">bluetoothData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">isMeasurementIn8bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mb">0b00000001</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b00000000</span>

        <span class="k">if</span> <span class="n">isMeasurementIn8bits</span> <span class="p">{</span>
            <span class="n">measurement8bits</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">measurement16bits</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>Note how you can use the <code>extract</code> function that Bluejay adds to <code>Data</code> to easily parse the bytes you need. We have plans to build more protection and error handling for this in the future.</p>

<p>Finally, while it is not essential and it will depend on the context, we suggest only exposing the needed and computed properties of your models.</p>
<h4 id='sendable' class='heading'>Sendable</h4>

<p>The models representing data you wish to send to your peripheral should all conform to the <code>Sendable</code> protocol.</p>

<p>In a nutshell, this is how you help Bluejay determine how to convert your models into <code>Data</code>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">WriteRequest</span><span class="p">:</span> <span class="kt">Sendable</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">handle</span><span class="p">:</span> <span class="kt">UInt16</span>
    <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Sendable</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">handle</span><span class="p">:</span> <span class="kt">UInt16</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Sendable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="k">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">toBluetoothData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Data</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">startByte</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x3A</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">payloadLength</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="nf">toBluetoothData</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
        <span class="k">let</span> <span class="nv">command</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">handleInBigEndian</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">bigEndian</span>

        <span class="k">let</span> <span class="nv">crc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">Bluejay</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">sendables</span><span class="p">:</span> <span class="p">[</span><span class="n">command</span><span class="p">,</span> <span class="n">handleInBigEndian</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span> <span class="k">as</span> <span class="kt">NSData</span><span class="p">)</span><span class="o">.</span><span class="n">crc16CCITT</span>

        <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">sendables</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">startByte</span><span class="p">,</span>
            <span class="n">payloadLength</span><span class="p">,</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">handleInBigEndian</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">crc</span><span class="o">.</span><span class="n">bigEndian</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="n">request</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>Note how we have a nested <code>Sendable</code> in this slightly more complicated model, as well as making use of the <code>combine</code> helper function to group and to arrange the data bytes in a particular order.</p>
<h4 id='sending-and-receiving-primitives' class='heading'>Sending and Receiving Primitives</h4>

<p>In some cases, you may want to send or receive data that is simple enough that creating a custom struct that implements <code>Sendable</code> or <code>Receivable</code> to hold it is unnecessarily complicated. For those cases, Bluejay also retroactively conforms several built-in Swift types to <code>Sendable</code> and <code>Receivable</code>. <code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code>, <code>UInt8</code>, <code>UInt16</code>, <code>UInt32</code>, <code>UInt64</code>, <code>Data</code> and <code>String</code>are all conformed to both protocols and so can be sent or received directly.</p>

<p><code>Int</code> and <code>UInt</code> are intentionally not conformed. Values are sent and/or received at a specific bit width. The intended bit width for an <code>Int</code> is ambiguous, and trying to use one often indicates a programmer error, in the form of not considering the bit width the Bluetooth device is expecting on a characteristic.</p>

<p><code>String</code> is sent and/or received UTF8 encoded.</p>
<h2 id='interactions' class='heading'>Interactions</h2>

<p>Once you have your data modelled using either the <code>Receivable</code> or <code>Sendable</code> protocol, the read, write, and listen APIs in Bluejay should handle the deserialization and serialization seamlessly for you. All you need to do is to specify the type for the generic result wrappers: <code>ReadResult&lt;T&gt;</code> or <code>WriteResult&lt;T&gt;</code>.</p>
<h3 id='reading' class='heading'>Reading</h3>

<p>Here is an example showing how to read the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml">sensor body location characteristic</a>, and converting its value to its corresponding label.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">location</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Read from sensor location is successful: </span><span class="se">\(</span><span class="n">location</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

    <span class="k">var</span> <span class="nv">locationString</span> <span class="o">=</span> <span class="s">"Unknown"</span>

    <span class="k">switch</span> <span class="n">location</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Other"</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Chest"</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Wrist"</span>
    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Finger"</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Hand"</span>
    <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Ear Lobe"</span>
    <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Foot"</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Unknown"</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">sensorLocationCell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">locationString</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">sensorLocation</span> <span class="o">=</span> <span class="n">location</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Cancelled read from sensor location."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to read from sensor location with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='writing' class='heading'>Writing</h3>

<p>Note that LightBlue Explorer&rsquo;s virtual heart sensor does not have write enabled for its sensor body location characteristic. See <a href="#demo">Demo</a> to find out how to enable it. However, if write is not allowed, the error object in the failure block will inform you.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">),</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Write to sensor location is successful."</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">selectedCell</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="o">.</span><span class="n">selectedCell</span> <span class="p">{</span>
        <span class="n">selectedCell</span><span class="o">.</span><span class="n">accessoryType</span> <span class="o">=</span> <span class="o">.</span><span class="k">none</span>
    <span class="p">}</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">accessoryType</span> <span class="o">=</span> <span class="o">.</span><span class="n">checkmark</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">navigationController</span><span class="p">?</span><span class="o">.</span><span class="nf">popViewController</span><span class="p">(</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Cancelled write to sensor location."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to write to sensor location with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>
<h3 id='listening' class='heading'>Listening</h3>

<p>Listening involves waiting for the Bluetooth device to write to a specific characteristic. When that happens the app will be notified that the write has taken place and the completion block will be called with the value read from the characteristic.</p>

<p>Unlike read and write, where completion blocks are called very soon (generally at most a few seconds) after the original call and are called only once, listens are persistent. It could be minutes (or never) before the receive block is called, and the block can be called multiple times.</p>

<p>When you don&rsquo;t want to listen anymore, you <strong>must</strong> explicitly remove it with the <code>endListen</code> method.  You can only have one active listen on a given characteristic at a time.</p>

<p>Not all characteristics support listening, it is a feature that must be enabled for a characteristic on the Bluetooth device itself.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">listen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRateMeasurement</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">HeartRateMeasurement</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">heartRateMeasurement</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">heartRateMeasurement</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Listen to heart rate measurement cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to listen to heart rate measurement with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='batch-operations' class='heading'>Batch Operations</h3>

<p>Often, your app needs to perform a longer series of reads, writes, and listens to complete a specific task, such as syncing, upgrading to a new firmware, or working with a notification-based Bluetooth module. In these cases, Bluejay provides an API for running all your operations on a background thread, and will call your completion on the main thread when everything finishes without an error, or if one of the operations has failed.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">heartRateMeasurement</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A37"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="nv">backgroundTask</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">peripheral</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UInt8</span> <span class="k">in</span>
    <span class="c1">// 1. Stop monitoring.</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Reset step 1: stop monitoring."</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">endListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRateMeasurement</span><span class="p">)</span>

    <span class="c1">// 2. Set sensor location to 0.</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Reset step 2: set sensor location to 0."</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1">// 3. Read sensor location.</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Reset step 3: read sensor location."</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">sensorLocation</span> <span class="o">=</span> <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UInt8</span>

    <span class="cm">/*
     Don't use the listen from the synchronized peripheral here to start monitoring the heart rate again, as it will actually block until it is turned off. The synchronous listen is for when you want to listen to and process some expected incoming values before moving on to the next steps in your background task. It is different from the regular asynchronous listen that is more commonly used for continuous monitoring.
     */</span>

    <span class="c1">// 4. Return the data interested and process it in the completion block on the main thread.</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Reset step 4: return sensor location."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sensorLocation</span>
<span class="p">})</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">RunResult</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">sensorLocation</span><span class="p">):</span>
        <span class="c1">// Update the sensor location label on the main thread.</span>
        <span class="n">weakSelf</span><span class="o">.</span><span class="nf">updateSensorLocationLabel</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">)</span>

        <span class="c1">// Resume monitoring. Now we can use the non-blocking listen from Bluejay, not from the SynchronizedPeripheral.</span>
        <span class="n">weakSelf</span><span class="o">.</span><span class="nf">startMonitoringHeartRate</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Cancelled reset background task."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to complete reset background task with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>It is critical though that when performing your Bluetooth operations in the background with <code>backgroundTask</code>, you <strong>must</strong> use the <code>SynchronizedPeripheral</code> given to you by this API. <strong>DO NOT</strong> call any <code>bluejay</code>.<code>read/write/listen</code> functions inside the <code>backgroundTask</code> block.</p>

<p>Note that because the <code>backgroundTask</code> block is running on a background thread, you need to be careful about accessing any global or captured data inside that block for thread safety reasons, like you would with any GCD or OperationQueue task. To help with this, Bluejay provides some other forms of <code>run(backgroundTask:completionOnMainThread:)</code> that allow you to pass user data into the background block and/or return a value from the background block that will be available in the success case of the result in the main thread block.</p>
<h2 id='background-operation' class='heading'>Background Operation</h2>

<p><a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/">Background Execution</a> is a mode supported by Core Bluetooth to allow apps to continue processing active Bluetooth operations when it is backgrounded or even when it is evicted from memory. For examples, a pending connect request that finishes, or a subscribed characteristic that fires a notification, can cause the system to wake or restart the app in the background. This can, for example, allow syncing data from a device without needing to manually launch the app.</p>

<p>In order to support background mode, make sure to turn on the <strong>Background Modes</strong> capability in your Xcode project with <strong>Uses Bluetooth LE accessories</strong> enabled.</p>

<p>Enabling background mode doesn&rsquo;t enable state restoration. State restoration is an additional behaviour on top of background mode that requires another step to setup.</p>
<h3 id='state-restoration' class='heading'>State Restoration</h3>

<p>Once your project has BLE accessories background mode enabled, you can choose to opt in to State Restoration when you start your Bluejay session.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">backgroundRestore</span><span class="p">:</span> <span class="o">.</span><span class="nf">enable</span><span class="p">(</span><span class="n">yourRestoreIdentifier</span><span class="p">))</span>
</code></pre>

<p>Additionally, Bluejay allows you to restore listen callbacks on subscribed characteristics that did not end when the app has stopped running.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">backgroundRestore</span><span class="p">:</span> <span class="o">.</span><span class="nf">enable</span><span class="p">(</span><span class="n">yourRestoreIdentifier</span><span class="p">,</span> <span class="n">yourListenRestorer</span><span class="p">))</span>
</code></pre>
<h3 id='listen-restoration' class='heading'>Listen Restoration</h3>

<p>If State Restoration is enabled and your app has stopped running either due to memory pressure or by staying in the background past the allowed duration (this has been 3 minutes since iOS 7), then the next time your app is launched in the background or foreground, Bluejay will call the <code>willRestoreListen</code> function on your <code>ListenRestorer</code> during state restoration if there are any active listens preserved.</p>

<p>The listen restorer protocol looks like this:</p>
<pre class="highlight swift"><code><span class="cm">/**
    A class protocol allowing notification of a characteristic being listened on, and provides an opportunity to restore its listen callback during Bluetooth state restoration.

    Bluetooth state restoration occurs when the background mode capability is turned on, and if the app is backgrounded or even terminated while a Bluetooth operation is still ongoing, iOS may keep the Bluetooth state alive, and attempt to restore it on resuming the app, so that the connection and operation between the app and the Bluetooth accessory is not interrupted and severed.
*/</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ListenRestorer</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="cm">/**
        Notify the conforming class that there is a characteristic being listened on, but it doesn't have any listen callbacks.

        - Note: Use the function `restoreListen` in Bluejay to restore the desired callback for the given characteristic and return true. Return false to prevent restoration, as well as to cancel the listening on the given characteristic.

        - Parameter on: the characterstic that is still being listened on when the CoreBluetooth stack is restored in the app.
        - Return: true if the characteristic's listen callback will be restored, false if the characteristic's listen should be cancelled and not restored.
    */</span>
    <span class="kd">func</span> <span class="nf">willRestoreListen</span><span class="p">(</span><span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span>
</code></pre>

<p>By default, if there is no <code>ListenRestorer</code> delegate provided in the <code>start</code> function, then Bluejay will cancel <strong>all</strong> active listens during state restoration.</p>

<p>Example:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">ListenRestorer</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">willRestoreListen</span><span class="p">(</span><span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">characteristic</span> <span class="o">==</span> <span class="n">heartRate</span> <span class="p">{</span>
            <span class="n">bluejay</span><span class="o">.</span><span class="nf">restoreListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRate</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Listen succeeded with value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Listen failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>

            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<h2 id='advanced-usage' class='heading'>Advanced Usage</h2>

<p>The following section will demonstrate a few advanced usage of Bluejay.</p>
<h3 id='connect-by-serial-number' class='heading'>Connect by Serial Number</h3>

<p>In a project we&rsquo;ve worked on, we had a device with a known serial number stored in a known characteristic that we want to connect to directly. However, Core Bluetooth doesn&rsquo;t support connection using a value from a characteristic.</p>

<p>To connect by serial number using Core Bluetooth, first you&rsquo;d have to scan for the services you know your device is advertising. Once your device is picked up by the scan, then you can grab its CBPeripheral handle and connect to it. But after connecting to it, you still have to verify its serial number by discovering and reading the value from the containing characteristic. If the serial number is not a match, then you&rsquo;d have to disconnect and repeat this process until you find the device with the serial number you&rsquo;re looking for.</p>

<p>Ideally, you&rsquo;d want your Bluetooth vendor or engineer to include the serial number or any other important identifiers in the device&rsquo;s advertising packet. But more often than not, various resource constraints do apply, and we can&rsquo;t always expect everything to follow best practices perfectly. Luckily, Bluejay does make this easier.</p>

<p>Here is a detailed summary of what the code below does and why:</p>

<p>We are maintaining a local collection of <q>blacklisted</q> discoveries that persist over multiple scan sessions. These are devices that don&rsquo;t have matching serial numbers. We can&rsquo;t just rely on the scan function&rsquo;s <q>blacklist</q> <code>ScanAction</code> alone, because the scan function&rsquo;s blacklist shares the same lifecycle as the scan itself. And to allow enqueueing a connection to a device for verifying its serial number, the scan has to end first, so it can be removed from the top of the operation queue. Therefore, we have to start a new scan if the serial number doesn&rsquo;t match.</p>

<p>Since we are starting a new scan every time we find a device with an incorrect serial number, the brand new scan session can still pick up a device we&rsquo;ve examined earlier. This is because the new scan session is unaware of devices previously blacklisted using the <q>blacklist</q> <code>ScanAction</code>. But, we can still find out whether a device is blacklisted using our <strong>own</strong> copy of the blacklist.</p>

<p>Returning <code>.blacklist</code> is not just a ceremonial task to ignore the current discovery within this scan session and to continue scanning. Doing so also adds some safety by preventing further discovery of the same device within the current scan session if <code>allowDuplicates</code> is set to true for some reasons. Interestingly, setting <code>allowDuplicates</code> to false has similar ignoring effect due to its coalescing behaviour, but we are doing this for an entirely different purpose â€“ to save battery.</p>

<p>The keys to understanding this example is to keep in mind that there are <strong>two</strong> copies of blacklists at play here, and to understand why we need to stop and restart a new scan for every discovery that isn&rsquo;t what we&rsquo;re looking for. First, there is one blacklist we are <strong>required</strong> to maintain ourselves that persists over multiple scan sessions, because Bluejay&rsquo;s FIFO operation queue requires the scan to finish before it can run the connection task. Secondly, there&rsquo;s the blacklist that Bluejay maintains for a scan session, but it is cleared as soon as that scan is finished.</p>
<pre class="highlight swift"><code><span class="c1">// Properties.</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">blacklistedDiscoveries</span> <span class="o">=</span> <span class="p">[</span><span class="kt">ScanDiscovery</span><span class="p">]()</span>    
<span class="kd">private</span> <span class="k">var</span> <span class="nv">targetSerialNumber</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>

<span class="c1">// Scan by Serial Number function.</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">scan</span><span class="p">(</span><span class="nv">services</span><span class="p">:</span> <span class="p">[</span><span class="kt">ServiceIdentifier</span><span class="p">],</span> <span class="nv">serialNumber</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Looking for peripheral with serial number </span><span class="se">\(</span><span class="n">serialNumber</span><span class="se">)</span><span class="s"> to connect to."</span><span class="p">)</span>

    <span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Searching..."</span>

    <span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
        <span class="nv">allowDuplicates</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="n">services</span><span class="p">,</span>
        <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">weakSelf</span><span class="o">.</span><span class="n">blacklistedDiscoveries</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">blacklistedDiscovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="k">in</span>
                <span class="k">return</span> <span class="n">blacklistedDiscovery</span><span class="o">.</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">discovery</span><span class="o">.</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">})</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="o">.</span><span class="n">blacklist</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="p">{</span> <span class="p">(</span><span class="n">connectionResult</span><span class="p">)</span> <span class="k">in</span>
                    <span class="k">switch</span> <span class="n">connectionResult</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">peripheral</span><span class="p">):</span>
                        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> successful."</span><span class="p">)</span>

                        <span class="n">weakSelf</span><span class="o">.</span><span class="n">bluejay</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Charactersitics</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">readResult</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
                            <span class="k">switch</span> <span class="n">readResult</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">serialNumber</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">serialNumber</span> <span class="o">==</span> <span class="n">weakSelf</span><span class="o">.</span><span class="n">targetSerialNumber</span> <span class="p">{</span>
                                    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Serial number matched."</span><span class="p">)</span>

                                    <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Connected"</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="p">{</span>
                                    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Serial number mismatch."</span><span class="p">)</span>

                                    <span class="n">weakSelf</span><span class="o">.</span><span class="n">blacklistedDiscoveries</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">discovery</span><span class="p">)</span>

                                    <span class="n">weakSelf</span><span class="o">.</span><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
                                        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
                                        <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
                                            <span class="n">weakSelf</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span><span class="nv">services</span><span class="p">:</span> <span class="p">[</span><span class="kt">Services</span><span class="o">.</span><span class="n">deviceInfo</span><span class="p">],</span> <span class="nv">serialNumber</span><span class="p">:</span> <span class="n">weakSelf</span><span class="o">.</span><span class="n">targetSerialNumber</span><span class="o">!</span><span class="p">)</span>
                                        <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
                                            <span class="nf">preconditionFailure</span><span class="p">(</span><span class="s">"Disconnection cancelled unexpectedly."</span><span class="p">)</span>
                                        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                                            <span class="nf">preconditionFailure</span><span class="p">(</span><span class="s">"Disconnection failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                                        <span class="p">}</span>
                                    <span class="p">})</span>
                                <span class="p">}</span>
                            <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
                                <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Read serial number cancelled."</span><span class="p">)</span>

                                <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Read Cancelled"</span>
                            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                                <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Read serial number failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">."</span><span class="p">)</span>

                                <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Read Error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
                        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">discovery</span><span class="o">.</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> cancelled."</span><span class="p">)</span>

                        <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Connection Cancelled"</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">discovery</span><span class="o">.</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

                        <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Connection Error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nv">expired</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">lostDiscovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">self</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
            <span class="p">}</span>

            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Lost discovery: </span><span class="se">\(</span><span class="n">lostDiscovery</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

            <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">})</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

            <span class="n">weakSelf</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Scan Error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='write-and-assemble' class='heading'>Write and Assemble</h3>

<p>One of the Bluetooth modules we&rsquo;ve worked with doesn&rsquo;t always send back data in one packet, even if the data is smaller than its maximum allowed packet size. To handle these incoming data that can be broken up into any number of packets arbitrarily, we&rsquo;ve introduced the <code>writeAndAssemble</code> API that is very similar to <code>writeAndListen</code> on the <code>SynchronizedPeripheral</code>. Therefore, at least for now, this is only supported in the context of <code>run(backgroundTask:completionOnMainThread:)</code>.</p>

<p>When using <code>writeAndAssemble</code>, we still expect you to know the total size of the data you are receiving, but Bluejay will keep listening and receiving packets until the expected size is reached before trying to deserialize the data into the object you need.</p>

<p>You can also specify a timeout in case something hangs or takes abnormally long.</p>

<p>Here is an example writing a request for a value to a Bluetooth module, so that it can return the value we want via a notification on a characteristic. And of course, we&rsquo;re not sure and have no control over how many packets the module will send back.</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">writeAndAssemble</span><span class="p">(</span>
    <span class="nv">writeTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoTX</span><span class="p">,</span>
    <span class="nv">value</span><span class="p">:</span> <span class="kt">ReadRequest</span><span class="p">(</span><span class="nv">handle</span><span class="p">:</span> <span class="kt">Registers</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">firmwareVersion</span><span class="p">),</span>
    <span class="nv">listenTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoRX</span><span class="p">,</span>
    <span class="nv">expectedLength</span><span class="p">:</span> <span class="kt">FirmwareVersion</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
    <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">firmwareVersion</span><span class="p">:</span> <span class="kt">FirmwareVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ListenAction</span> <span class="k">in</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">firmwareVersion</span><span class="o">.</span><span class="n">string</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">done</span>
<span class="p">})</span>
</code></pre>
<h3 id='flush-listen' class='heading'>Flush Listen</h3>

<p>Some Bluetooth modules will pause sending data when it loses connection to your app, and will resume sending the same set of data from where it left off when the connection is re-established. This isn&rsquo;t an issue most of the time. However, if the connection loss is due to a crash in your app, or something that causes your listen callback to be deallocated before the connection is re-established, then it is often very difficult to resume your app with the exact same content and context at the time of the connection loss.</p>

<p>For example, you might have to re-authenticate the user when the app is re-opened. But if authentication requires listening to the same characteristic where the incomplete data set is still being sent, then you will be getting back unexpected values and most likely crash when trying to deserialize authentication related objects.</p>

<p>To handle this, it is often a good idea to flush a notifiable characteristic before starting a critical first-time and/or setup related operation. This is also only available on the <code>SynchronizedPeripheral</code> in the context of <code>run(backgroundTask:completionOnMainThread:)</code> for now.</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">flushListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoRX</span><span class="p">,</span> <span class="nv">idleWindow</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Flushed buffered data on RigadoRX."</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>

<p>The <code>idleWindow</code> is in seconds, and basically specifies the duration of the absence of incoming data needed to predict that the flush is most likely completed. Note that this is still an estimation. Depending on your Bluetooth hardware and usage environments and conditions, a longer window might be necessary.</p>
<h2 id='api-documentation' class='heading'>API Documentation</h2>

<p>We have more <a href="https://steamclock.github.io/bluejay/index.html">in-depth API documentation for Bluejay</a> using inline documentation and Jazzy.</p>

          </section>
        </section>
        <section id="footer">
          <p>Copyright Â© 2017 Steamclock Software. All rights reserved.</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy â™ªâ™« v0.8.3</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
