<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bluejay  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Bluejay  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Bluejay Docs</a> (100% documented)</p>
        <p class="header-right"><a href="https://github.com/steamclock/bluejay"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Bluejay Reference</a>
        <img id="carat" src="img/carat.png" />
        Bluejay  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Bluejay.html">Bluejay</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/AutoReconnectMode.html">AutoReconnectMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BackgroundRestoreCompletion.html">BackgroundRestoreCompletion</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BackgroundRestoreMode.html">BackgroundRestoreMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BluejayError.html">BluejayError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ConnectionResult.html">ConnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DisconnectionResult.html">DisconnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ListenAction.html">ListenAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ListenRestoreAction.html">ListenRestoreAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/MultipleListenOption.html">MultipleListenOption</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ReadResult.html">ReadResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RunResult.html">RunResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ScanAction.html">ScanAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/StartMode.html">StartMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/Timeout.html">Timeout</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/WriteResult.html">WriteResult</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/BinaryInteger.html">BinaryInteger</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBManagerState.html">CBManagerState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheral.html">CBPeripheral</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheralState.html">CBPeripheralState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBService.html">CBService</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Data.html">Data</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Peripheral.html">Peripheral</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/BackgroundRestorer.html">BackgroundRestorer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ConnectionObserver.html">ConnectionObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DisconnectHandler.html">DisconnectHandler</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols.html#/s:7Bluejay10FixedWidthP">FixedWidth</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ListenRestorer.html">ListenRestorer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/LogObserver.html">LogObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RSSIObserver.html">RSSIObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Receivable.html">Receivable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Sendable.html">Sendable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ServiceObserver.html">ServiceObserver</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/BackgroundRestoreConfig.html">BackgroundRestoreConfig</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/CharacteristicIdentifier.html">CharacteristicIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DataPadding.html">DataPadding</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PeripheralIdentifier.html">PeripheralIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ScanDiscovery.html">ScanDiscovery</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ServiceIdentifier.html">ServiceIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/StartOptions.html">StartOptions</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/WarningOptions.html">WarningOptions</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:7Bluejay13LaunchOptionsa">LaunchOptions</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:7Bluejay14ListenCallbacka">ListenCallback</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:7Bluejay17RestoreIdentifiera">RestoreIdentifier</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <p><img src="https://raw.githubusercontent.com/steamclock/bluejay/master/bluejay-wordmark.png" alt="Bluejay"></p>

<p><img src="https://img.shields.io/cocoapods/v/Bluejay.svg" alt="CocoaPods Compatible">
<img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible">
<a href="http://cocoadocs.org/docsets/Bluejay"><img src="https://img.shields.io/cocoapods/p/Bluejay.svg?style=flat" alt="Platform"></a>
<a href=""><img src="https://img.shields.io/github/license/mashape/apistatus.svg" alt="license"></a></p>

<p>Bluejay is a simple Swift framework for building reliable Bluetooth LE apps.</p>

<p>Bluejay&rsquo;s primary goals are:</p>

<ul>
<li>Simplify talking to a single Bluetooth LE peripheral</li>
<li>Make it easier to handle Bluetooth operations reliably</li>
<li>Take advantage of Swift features and conventions</li>
</ul>
<h2 id='index' class='heading'>Index</h2>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#usage">Usage</a>

<ul>
<li><a href="#initialization">Initialization</a></li>
<li><a href="#bluetooth-events">Bluetooth Events</a></li>
<li><a href="#services-and-characteristics">Services and Characteristics</a></li>
<li><a href="#scanning">Scanning</a></li>
<li><a href="#connecting">Connecting</a></li>
<li><a href="#disconnect">Disconnect</a></li>
<li><a href="#cancel-everything">Cancel Everything</a></li>
<li><a href="#auto-reconnect">Auto Reconnect</a></li>
<li><a href="#disconnect-handler">Disconnect Handler</a></li>
<li><a href="#connection-states">Connection States</a></li>
</ul></li>
<li><a href="#deserialization-and-serialization">Deserialization and Serialization</a>

<ul>
<li><a href="#receivable">Receivable</a></li>
<li><a href="#sendable">Sendable</a></li>
<li><a href="#sending-and-receiving-primitives">Sending and Receiving Primitives</a></li>
<li><a href="#strings">Strings</a></li>
</ul></li>
<li><a href="#interactions">Interactions</a>

<ul>
<li><a href="#reading">Reading</a></li>
<li><a href="#writing">Writing</a></li>
<li><a href="#listening">Listening</a></li>
<li><a href="#background-task">Background Task</a></li>
</ul></li>
<li><a href="#background-restoration">Background Restoration</a>

<ul>
<li><a href="#background-permission">Background Permission</a></li>
<li><a href="#state-restoration">State Restoration</a></li>
<li><a href="#listen-restoration">Listen Restoration</a></li>
</ul></li>
<li><a href="#advanced-usage">Advanced Usage</a>

<ul>
<li><a href="#write-and-assemble">Write and Assemble</a></li>
<li><a href="#flush-listen">Flush Listen</a></li>
<li><a href="#corebluetooth-migration">CoreBluetooth Migration</a></li>
<li><a href="#monitor-peripheral-services">Monitor Peripheral Services</a></li>
</ul></li>
</ul>
<h2 id='features' class='heading'>Features</h2>

<ul>
<li>A callback-based API</li>
<li>A FIFO operation queue for more synchronous and predictable behaviour</li>
<li>A background task mode for batch operations that avoids the <q>callback pyramid of death</q></li>
<li>Simple protocols for data serialization and deserialization</li>
<li>An easy and safe way to observe connection states</li>
<li>Powerful background restoration support</li>
<li>Extended error handling and logging support</li>
</ul>
<h2 id='requirements' class='heading'>Requirements</h2>

<ul>
<li>iOS 10 or above</li>
<li>Xcode 10 or above</li>
<li>Swift 4.2 or above</li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>
<h3 id='cocoapods' class='heading'>CocoaPods</h3>

<p><code>pod &#39;Bluejay&#39;, &#39;~&gt; 0.8&#39;</code></p>

<p>Or to try the latest master:</p>

<p><code>pod &#39;Bluejay&#39;, :git =&gt; &#39;https://github.com/steamclock/bluejay.git&#39;, :branch =&gt; &#39;master&#39;</code></p>
<h3 id='carthage' class='heading'>Carthage</h3>
<pre class="highlight plaintext"><code>github "steamclock/bluejay" ~&gt; 0.8
github "DaveWoodCom/XCGLogger" ~&gt; 6.1.0
</code></pre>

<p>Refer to <a href="https://github.com/Carthage/Carthage#supporting-carthage-for-your-framework">official Carthage documentation</a> for the rest of the instructions.</p>

<p><strong>Note:</strong> <code>Bluejay.framework</code>, <code>ObjcExceptionBridging.framework</code>, and <code>XCGLogger.framework</code> are all required.</p>
<h3 id='import' class='heading'>Import</h3>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Bluejay</span>
</code></pre>
<h2 id='demo' class='heading'>Demo</h2>

<p>The iOS Simulator does not simulate Bluetooth, and you may not have a debuggable Bluetooth LE peripheral handy, so we have prepared you a pair of demo apps to test with.</p>

<ol>
<li><strong>BluejayHeartSensorDemo:</strong> an app that can connect to a Bluetooth LE heart sensor.</li>
<li><strong>DittojayHeartSensorDemo:</strong> a virtual Bluetooth LE heart sensor.</li>
</ol>
<h4 id='to-try-out-bluejay' class='heading'>To try out Bluejay:</h4>

<ol>
<li>Get two iOS devices â€“ one to run <strong>Bluejay Demo</strong>, and the other to run <strong>Dittojay Demo</strong>.</li>
<li>Grant permission for notifications on <strong>Bluejay Demo</strong>.</li>
<li>Grant permission for background mode on <strong>Dittojay Demo</strong>.</li>
<li>Connect using <strong>Bluejay Demo</strong>.</li>
</ol>
<h4 id='to-try-out-background-restoration-after-connecting' class='heading'>To try out background restoration (after connecting):</h4>

<ol>
<li>In <strong>Bluejay Demo</strong>, tap on <q>End listen to heart rate</q>.</li>
<li>This is to prevent the continuous heart rate notification from triggering state restoration right after we terminate the app, as it&rsquo;s much clearer and easier to verify state restoration when we can manually trigger a Bluetooth event at our own leisure and timing.</li>
<li>Tap on <q>Terminate app</q>.</li>
<li>This will crash the app, but also simulate app termination due to memory pressure, <strong>and</strong> allow CoreBluetooth to cache the current session and wait for Bluetooth events to begin state restoration.</li>
<li>In <strong>Dittojay Demo</strong>, tap on <q>Chirp</q> to <em>revive</em> <strong>Bluejay Demo</strong></li>
<li>This will send a Bluetooth event to the device with the terminated <strong>Bluejay Demo</strong>, and its CoreBluetooth stack will wake up the app in the background and execute a few quick tasks, such as scheduling a few local notifications for verification and debugging purposes in this case.</li>
</ol>
<h2 id='usage' class='heading'>Usage</h2>
<h3 id='initialization' class='heading'>Initialization</h3>

<p>To create an instance of Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">bluejay</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="p">()</span>
</code></pre>

<p>While it is convenient to create one Bluejay instance and use it everywhere, you can also create instances in specific portions of your app and tear them down after use. It&rsquo;s worth noting, however, that each instance of Bluejay has its own <a href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanager">CBCentralManager</a>, which makes the multi-instance approach somewhat more complex.</p>

<p>Once you&rsquo;ve created an instance, you can start running Bluejay, which will then initialize the <a href="https://developer.apple.com/documentation/corebluetooth">CoreBluetooth</a> session. Note that <strong>instantiating a Bluejay instance and running a Bluejay instance are two separate operations.</strong></p>

<p>You must always start Bluejay in your AppDelegate&rsquo;s <code>application(_:didFinishLaunchingWithOptions:)</code> if you want to support <a href="#background-restoration">background restoration</a>, otherwise you are free to start Bluejay anywhere appropriate in your app. For example, apps that don&rsquo;t require background restoration often initialize and start their Bluejay instance from the initial view controller.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>

<p>If your app needs Bluetooth to work in the background, then you have to support background restoration in your app. While Bluejay has already simplified much of background restoration for you, <a href="#background-restoration">it will still take some extra work</a>, and we also recommend reviewing the <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html">relevant Apple docs</a>. Background restoration is tricky and difficult to get right.</p>

<p>Bluejay also supports <a href="#corebluetooth-migration">CoreBluetooth migration</a> for working with other Bluetooth libraries or with your own Bluetooth code.</p>
<h3 id='bluetooth-events' class='heading'>Bluetooth Events</h3>

<p>The <code><a href="Protocols/ConnectionObserver.html">ConnectionObserver</a></code> protocol allows a class to monitor and to respond to major Bluetooth and connection-related events:</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ConnectionObserver</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">bluetoothAvailable</span><span class="p">(</span><span class="n">_</span> <span class="nv">available</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">connected</span><span class="p">(</span><span class="n">to</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">disconnected</span><span class="p">(</span><span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can register a connection observer using:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">connectionObserver</span><span class="p">:</span> <span class="n">batteryLabel</span><span class="p">)</span>
</code></pre>

<p>Unregistering a connection observer is not necessary, because Bluejay only holds weak references to registered observers, so Bluejay will clear nil observers from its list when they are found at the next event&rsquo;s firing. But if you need to do so before that happens, you can use:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">unregister</span><span class="p">(</span><span class="nv">connectionObserver</span><span class="p">:</span> <span class="n">rssiLabel</span><span class="p">)</span>
</code></pre>
<h3 id='services-and-characteristics' class='heading'>Services and Characteristics</h3>

<p>In Bluetooth parlance, a Service is a group of attributes, and a Characteristic is an attribute belonging to a group. For example, BLE peripherals that can detect heart rates typically have a Service named <q>Heart Rate</q> with a UUID of <q>180D</q>. Inside that Service are Characteristics such as <q>Body Sensor Location</q> with a UUID of <q>2A38</q>, as well as <q>Heart Rate Measurement</q> with a UUID of <q>2A37</q>.</p>

<p>Many of these Services and Characteristics are standards specified by the Bluetooth SIG organization, and most hardware adopt their specifications. For example, most BLE peripherals implement the Service <q>Device Information</q> which has a UUID of <q>180A</q>, which is where Characteristics such as firmware version, serial number, and other hardware details can be found. Of course, there are many BLE uses not covered by the Bluetooth Core Spec, and custom hardware often have their own unique Services and Characteristics.</p>

<p>Here is how you can specify Services and Characteristics for use in Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bodySensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">heartRate</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A37"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
</code></pre>

<p>Bluejay uses the <code><a href="Structs/ServiceIdentifier.html">ServiceIdentifier</a></code> and <code><a href="Structs/CharacteristicIdentifier.html">CharacteristicIdentifier</a></code> structs to avoid problems like accidentally specifying a Service when a Characteristic is expected.</p>
<h3 id='scanning' class='heading'>Scanning</h3>

<p>Bluejay has a powerful scanning API that can be be used simply or customized to satisfy many use cases.</p>

<p>CoreBluetooth scans for devices using services. In other words, CoreBluetooth, and therefore Bluejay, expects you to know beforehand one or several public services the peripherals you want to scan for contains.</p>
<h4 id='basic-scanning' class='heading'>Basic Scanning</h4>

<p>This simple call will just notify you when there is a new discovery, and when the scan has finished:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="p">[</span><span class="n">heartRateService</span><span class="p">],</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
        <span class="p">}</span>

        <span class="n">weakSelf</span><span class="o">.</span><span class="n">discoveries</span> <span class="o">=</span> <span class="n">discoveries</span>
        <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

        <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">stopped</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>A scan result <code>(ScanDiscovery, [ScanDiscovery])</code> contains the current discovery followed by an array of all the discoveries made so far.</p>

<p>The stopped result contains a final list of discoveries available just before stopping, and an error if there is one. If there isn&rsquo;t an error, that means that the scan was stopped intentionally or expectedly.</p>
<h4 id='scan-action' class='heading'>Scan Action</h4>

<p>A <code><a href="Enums/ScanAction.html">ScanAction</a></code> is returned at the end of a discovery callback to tell Bluejay whether to keep scanning or to stop.</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ScanAction</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">`</span><span class="nv">continue</span><span class="p">`</span>
    <span class="k">case</span> <span class="n">blacklist</span>
    <span class="k">case</span> <span class="n">stop</span>
    <span class="k">case</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">ScanDiscovery</span><span class="p">,</span> <span class="p">(</span><span class="kt">ConnectionResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Returning <code>blacklist</code> will ignore any future discovery of the same peripheral within the current scan session. This is only useful when <code>allowDuplicates</code> is set to true. See <a href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanagerscanoptionallowduplicateskey?language=objc">Apple docs on CBCentralManagerScanOptionAllowDuplicatesKey</a> for more info.</p>

<p>Returning <code>connect</code> will make Bluejay stop the scan as well as perform your connection request. This is useful if you want to connect right away when you&rsquo;ve found the peripheral you&rsquo;re looking for.</p>

<p><strong>Tip:</strong> You can set up the <code><a href="Enums/ConnectionResult.html">ConnectionResult</a></code> block outside the scan call to reduce callback nesting.</p>
<h4 id='monitoring' class='heading'>Monitoring</h4>

<p>Another useful way to use the scanning API is to scan continuously, i.e. to monitor, for purposes such as observing the RSSI changes of nearby peripherals to estimate their proximity:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">duration</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="nv">allowDuplicates</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
        <span class="p">}</span>

        <span class="n">weakSelf</span><span class="o">.</span><span class="n">discoveries</span> <span class="o">=</span> <span class="n">discoveries</span>
        <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

        <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">expired</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">lostDiscovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
        <span class="p">}</span>

        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Lost discovery: </span><span class="se">\(</span><span class="n">lostDiscovery</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="n">weakSelf</span><span class="o">.</span><span class="n">discoveries</span> <span class="o">=</span> <span class="n">discoveries</span>
        <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

        <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
<span class="p">})</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Setting <code>allowDuplicates</code> to true will stop coalescing multiple discoveries of the same peripheral into one single discovery callback. Instead, you&rsquo;ll get a discovery call every time a peripheral&rsquo;s advertising packet is picked up. This will <strong>consume more battery, and does not work in the background</strong>.</p>

<p><strong>Warning:</strong> An allow duplicates scan will stop with an error if your app is backgrounded during the scan.</p>

<p>The <code>expired</code> callback is only invoked when <code>allowDuplicates</code> is true. This is called when Bluejay estimates that a previously discovered peripheral is likely out of range or no longer broadcasting. Essentially, when <code>allowDuplicates</code> is set to true, every time a peripheral is discovered a timer associated with that peripheral starts counting down. If that peripheral is within range, and even if it has a slow broadcasting interval, it is likely that peripheral will be picked up by the scan again and cause the timer to refresh. If not and the timer expires without being refreshed, Bluejay makes an educated guess and suggests that the peripheral is no longer reachable. Be aware that this is an estimation.</p>

<p><strong>Warning</strong>: Setting <code>serviceIdentifiers</code> to <code>nil</code> will result in picking up all available Bluetooth peripherals in the vicinity, <strong>but is not recommended by Apple</strong>. It may cause <strong>battery and cpu issues</strong> on prolonged scanning, and it also <strong>doesn&rsquo;t work in the background</strong>. It is not a private API call, but an available option where you need a quick solution when testing and prototyping.</p>

<p><strong>Tip:</strong> Specifying at least one specific service identifier is the most common way to scan for Bluetooth devices in iOS. If you need to scan for all Bluetooth devices, we recommend making use of the <code>duration</code> parameter to stop the scan after 5 ~ 10 seconds to avoid scanning indefinitely and overloading the hardware.</p>
<h3 id='connecting' class='heading'>Connecting</h3>

<p>It is important to keep in mind that Bluejay is designed to work with a single BLE peripheral. Multiple connections at once is not currently supported, and a connection request will fail if Bluejay is already connected or is still connecting. Although this can be a limitation for some sophisticated apps, it is more commonly a safeguard to ensure your app does not issue connections unnecessarily or erroneously.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">selectedSensor</span><span class="p">,</span> <span class="nv">timeout</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection attempt to: </span><span class="se">\(</span><span class="n">selectedSensor</span><span class="o">.</span><span class="n">description</span><span class="se">)</span><span class="s"> is successful"</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to connect with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='timeouts' class='heading'>Timeouts</h4>

<p>You can also specify a timeout for a connection request, default is no timeout:</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">Timeout</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">seconds</span><span class="p">(</span><span class="kt">TimeInterval</span><span class="p">)</span>
    <span class="k">case</span> <span class="k">none</span>
<span class="p">}</span>
</code></pre>

<p><strong>Tip:</strong> We recommend always setting at least a 15 seconds timeout for your connection requests.</p>
<h3 id='disconnect' class='heading'>Disconnect</h3>

<p>To disconnect:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
</code></pre>

<p>Bluejay also supports finer controls over your disconnection:</p>
<h4 id='queued-disconnect' class='heading'>Queued Disconnect</h4>

<p>A queued disconnect will be queued like all other Bluejay API requests, so the disconnect attempt will wait for its turn until all the queued tasks are finished.</p>

<p>To perform a queued disconnect, simply call:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
</code></pre>
<h4 id='immediate-disconnect' class='heading'>Immediate Disconnect</h4>

<p>An immediate disconnect will immediately fail and empty all tasks from the queue even if they are still running and then immediately disconnect.</p>

<p>There are two ways to perform an immediate disconnect:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">(</span><span class="nv">immediate</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</code></pre>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">cancelEverything</span><span class="p">()</span>
</code></pre>
<h4 id='expected-vs-unexpected-disconnection' class='heading'>Expected vs Unexpected Disconnection</h4>

<p>Bluejay&rsquo;s log will describe in detail whether a disconnection is expected or unexpected. This is important when debugging a disconnect-related issue, as well as explaining why Bluejay is or isn&rsquo;t attempting to auto reconnect.</p>

<p>Any explicit call to <code>disconnect</code> or <code>cancelEverything</code> with disconnect will result in an expected disconnection.</p>

<p>All other disconnection events will be considered unexpected. For examples:</p>

<ul>
<li>If a connection attempt fails due to hardware errors and not from a timeout</li>
<li>If a connected device moves out of range</li>
<li>If a connected device runs out of battery or is shut off</li>
<li>If a connected device&rsquo;s Bluetooth module crashes and is no longer negotiable</li>
</ul>
<h3 id='cancel-everything' class='heading'>Cancel Everything</h3>

<p>The reason why there is a <code>cancelEverything</code> API in addition to <code>disconnect</code>, is because sometimes we want to cancel everything in the queue but <strong>remain</strong> connected.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">cancelEverything</span><span class="p">(</span><span class="nv">shouldDisconnect</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
</code></pre>
<h3 id='auto-reconnect' class='heading'>Auto Reconnect</h3>

<p>By default, <code>shouldAutoReconnect</code> is <code>true</code> and Bluejay will always try to automatically reconnect after an unexpected disconnection.</p>

<p>Bluejay will only set <code>shouldAutoReconnect</code> to <code>false</code> under these circumstances:</p>

<ol>
<li>If you manually call <code>disconnect</code> and the disconnection is successful.</li>
<li>If you manually call <code>cancelEverything</code> and its disconnection is successful.</li>
</ol>

<p>Bluejay will also <strong>always</strong> reset <code>shouldAutoReconnect</code> to <code>true</code> on a successful connection to a peripheral, as we usually want to reconnect to the same device as soon as possible if a connection is lost unexpectedly during normal usage.</p>

<p>However, there are some cases where auto reconnect is not desirable. In those cases, use a <code><a href="Protocols/DisconnectHandler.html">DisconnectHandler</a></code> to evaluate and to override auto reconnect.</p>
<h3 id='disconnect-handler' class='heading'>Disconnect Handler</h3>

<p>A disconnect handler is a single delegate that is suitable for performing major recovery, retry, or reset operations, such as restarting a scan when there is a disconnection.</p>

<p>The purpose of this handler is to help avoid writing and repeating major resuscitation and error handling logic inside the error callbacks of your regular connect, disconnect, read, write, and listen calls. Use the disconnect handler to perform one-time and significant operations at the very end of a disconnection.</p>

<p>In addition to helping you avoid redundant and conflicted logic in various callbacks when there is a disconnection, the disconnect handler also allows you to evaluate and to control Bluejay&rsquo;s auto-reconnect behaviour.</p>

<p>For example, this protocol implementation will always turn off auto reconnect whenever there is a disconnection, expected or not.</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">didDisconnect</span><span class="p">(</span>
  <span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">,</span>
  <span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span>
  <span class="n">willReconnect</span> <span class="nv">autoReconnect</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AutoReconnectMode</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">.</span><span class="nf">change</span><span class="p">(</span><span class="nv">shouldAutoReconnect</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>We also anticipate that for most apps, different view controllers may want to handle disconnection differently, so simply register and replace the existing disconnect handler as your user navigates to different parts of your app.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">registerDisconnectHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
</code></pre>

<p>Similar to connection observers, you do not have to explicitly unregister unless you need to.</p>
<h3 id='connection-states' class='heading'>Connection States</h3>

<p>Your Bluejay instance has these properties to help you make connection-related decisions:</p>

<ul>
<li><code>isBluetoothAvailable</code></li>
<li><code>isBluetoothStateUpdateImminent</code></li>
<li><code>isConnecting</code></li>
<li><code>isConnected</code></li>
<li><code>isDisconnecting</code></li>
<li><code>shouldAutoReconnect</code></li>
<li><code>isScanning</code></li>
<li><code>hasStarted</code></li>
<li><code>defaultWarningOptions</code></li>
<li><code>isBackgroundRestorationEnabled</code></li>
</ul>
<h2 id='deserialization-and-serialization' class='heading'>Deserialization and Serialization</h2>

<p>Reading, writing, and listening to Characteristics is straightforward in Bluejay. Most of the work involved is building out the deserialization and serialization for your data. Let&rsquo;s have a quick look at how Bluejay helps standardize this process in your app via the <code><a href="Protocols/Receivable.html">Receivable</a></code> and <code><a href="Protocols/Sendable.html">Sendable</a></code> protocols.</p>
<h4 id='receivable' class='heading'>Receivable</h4>

<p>Models that represent data you wish to read and receive from your peripheral should all conform to the <code><a href="Protocols/Receivable.html">Receivable</a></code> protocol.</p>

<p>Here is a partial example for the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml">Heart Rate Measurement Characteristic</a>:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Bluejay</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">struct</span> <span class="kt">HeartRateMeasurement</span><span class="p">:</span> <span class="kt">Receivable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement8bits</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement16bits</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">energyExpended</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">rrInterval</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">isMeasurementIn8bits</span> <span class="o">=</span> <span class="kc">true</span>

    <span class="k">var</span> <span class="nv">measurement</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">isMeasurementIn8bits</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement8bits</span><span class="p">)</span> <span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement16bits</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">bluetoothData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">isMeasurementIn8bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mb">0b00000001</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b00000000</span>

        <span class="k">if</span> <span class="n">isMeasurementIn8bits</span> <span class="p">{</span>
            <span class="n">measurement8bits</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">measurement16bits</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

</code></pre>

<p>Note how you can use the <code>extract</code> function that Bluejay adds to <code>Data</code> to easily parse the bytes you need. We have plans to build more protection and error handling for this in the future.</p>

<p>Finally, while it is not essential and it will depend on the context, we suggest only exposing the needed and computed properties of your models.</p>
<h4 id='sendable' class='heading'>Sendable</h4>

<p>Models representing data you wish to send to your peripheral should all conform to the <code><a href="Protocols/Sendable.html">Sendable</a></code> protocol. In a nutshell, this is how you help Bluejay determine how to convert your models into <code>Data</code>:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Bluejay</span>

<span class="kd">struct</span> <span class="kt">Coffee</span><span class="p">:</span> <span class="kt">Sendable</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">UInt8</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">coffee</span><span class="p">:</span> <span class="kt">CoffeeEnum</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">coffee</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">toBluetoothData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Data</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">Bluejay</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">sendables</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">])</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>The <code>combine</code> helper function makes it easier to group and to sequence the outgoing data.</p>
<h4 id='sending-and-receiving-primitives' class='heading'>Sending and Receiving Primitives</h4>

<p>In some cases, you may want to send or receive data simple enough that creating a custom struct which implements <code><a href="Protocols/Sendable.html">Sendable</a></code> or <code><a href="Protocols/Receivable.html">Receivable</a></code> to hold it is unnecessarily complicated. For those cases, Bluejay also retroactively conforms several built-in Swift types to <code><a href="Protocols/Sendable.html">Sendable</a></code> and <code><a href="Protocols/Receivable.html">Receivable</a></code>. <code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code>, <code>UInt8</code>, <code>UInt16</code>, <code>UInt32</code>, <code>UInt64</code>, <code>Data</code> are all conformed to both protocols and so they can all be sent or received directly.</p>

<p><code>Int</code> and <code>UInt</code> are intentionally not conformed. Bluetooth values are always sent and/or received at a specific bit width. The intended bit width for an <code>Int</code> is ambiguous, and trying to use one often indicates a programmer error, in the form of not considering the bit width the Bluetooth device is expecting on a characteristic.</p>
<h4 id='strings' class='heading'>Strings</h4>

<p><code>String</code> is special because encoding can vary and it is not a fixed width type, so you cannot use a <code>String</code> on its own as a <code><a href="Protocols/Sendable.html">Sendable</a></code> nor <code><a href="Protocols/Receivable.html">Receivable</a></code>. To work around this, wrap the string data inside a <code><a href="Protocols/Sendable.html">Sendable</a></code> and/or <code><a href="Protocols/Receivable.html">Receivable</a></code> struct, then use iOS&rsquo; <code>Foundation</code> framework to serialize and/or to deserialize. But when deserializing, one of Bluejay&rsquo;s <code>extract</code> helpers does provide a slightly more convenient interface. For examples:</p>

<p><strong>Serializing a packet containing a string</strong></p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">MyBluetoothPacket</span><span class="p">:</span> <span class="kt">Sendable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">deviceName</span><span class="p">:</span> <span class="kt">String</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">deviceName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">deviceName</span> <span class="o">=</span> <span class="n">deviceName</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">toBluetoothData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Data</span> <span class="p">{</span>
        <span class="c1">// Should probably validate the length here before sending it to your peripheral.</span>
        <span class="k">return</span> <span class="n">deviceName</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p><strong>Deserializing a packet containing a string</strong></p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">MyBluetoothPacket</span><span class="p">:</span> <span class="kt">Receivable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">deviceName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">bluetoothData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="n">deviceName</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p><strong>Note:</strong> As with the majority of Bluetooth data you work with, you should know the length beforehand, and especially so for both incoming and outgoing strings.</p>
<h2 id='interactions' class='heading'>Interactions</h2>

<p>Once you have your data modelled using either the <code><a href="Protocols/Receivable.html">Receivable</a></code> or <code><a href="Protocols/Sendable.html">Sendable</a></code> protocol, the read, write, and listen APIs in Bluejay should handle the deserialization and serialization seamlessly for you. All you need to do is to specify the type for the generic result wrappers: <code><a href="Enums/ReadResult.html">ReadResult&lt;T&gt;</a></code> or <code><a href="Enums/WriteResult.html">WriteResult&lt;T&gt;</a></code>.</p>
<h3 id='reading' class='heading'>Reading</h3>

<p>Here is an example showing how to read the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml">sensor body location characteristic</a>, and converting its value to its corresponding string and display it in the UI.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">location</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Read from sensor location is successful: </span><span class="se">\(</span><span class="n">location</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="k">var</span> <span class="nv">locationString</span> <span class="o">=</span> <span class="s">"Unknown"</span>

        <span class="k">switch</span> <span class="n">location</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Other"</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Chest"</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Wrist"</span>
        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Finger"</span>
        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Hand"</span>
        <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Ear Lobe"</span>
        <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Foot"</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="n">locationString</span> <span class="o">=</span> <span class="s">"Unknown"</span>
        <span class="p">}</span>

        <span class="n">weakSelf</span><span class="o">.</span><span class="n">sensorLocationCell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">locationString</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to read sensor location with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='writing' class='heading'>Writing</h3>

<p>Writing to a characteristic is very similar to reading:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">sensorLocation</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Write to sensor location is successful."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to write sensor location with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='listening' class='heading'>Listening</h3>

<p>Listening turns on broadcasting on a characteristic and allows you to receive its notifications.</p>

<p>Unlike read and write where the completion block is only called once, listen callbacks are persistent. It could be minutes (or never) before the receive block is called, and the block can be called multiple times.</p>

<p>Some Bluetooth devices will turn off notifications when it is disconnected, some don&rsquo;t. That said, when you don&rsquo;t need to listen anymore, it is generally good practice to always explicitly turn off broadcasting on that characteristic using the <code>endListen</code> function.</p>

<p>Not all characteristics support listening, it is a feature that must be enabled for a characteristic on the Bluetooth device itself.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">heartRateCharacteristic</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A37"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">listen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRateCharacteristic</span><span class="p">,</span> <span class="nv">multipleListenOption</span><span class="p">:</span> <span class="o">.</span><span class="n">replaceable</span><span class="p">)</span>
<span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">HeartRateMeasurement</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">heartRate</span><span class="p">):</span>
            <span class="n">weakSelf</span><span class="o">.</span><span class="n">heartRate</span> <span class="o">=</span> <span class="n">heartRate</span>
            <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to listen with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='multiple-listen-options' class='heading'>Multiple Listen Options</h4>

<p>You can only have one listener callback installed per characteristic. If you need multiple observers on the same characteristic, you can still do so yourself using just one Bluejay listener and within it create your own app-specific notifications.</p>

<p>Pass in the appropriate <code><a href="Enums/MultipleListenOption.html">MultipleListenOption</a></code> in your listen call to either protect against multiple listen attempts on the same characteristic, or to intentionally allow overwriting an existing listen.</p>
<pre class="highlight swift"><code><span class="c1">/// Ways to handle calling listen on the same characteristic multiple times.</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">MultipleListenOption</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="c1">/// New listen on the same characteristic will not overwrite an existing listen.</span>
    <span class="k">case</span> <span class="n">trap</span>
    <span class="c1">/// New listens on the same characteristic will replace the existing listen.</span>
    <span class="k">case</span> <span class="n">replaceable</span>
<span class="p">}</span>
</code></pre>
<h3 id='background-task' class='heading'>Background Task</h3>

<p>Bluejay also supports performing a longer series of reads, writes, and listens in a background thread. Each operation in a background task is blocking and will not return until completed.</p>

<p>This is useful when you need to complete a specific and large task such as syncing or upgrading to a new firmware. This is also useful when working with a notification-based Bluetooth module where you need to pause and wait for Bluetooth execution, primarily the listen operation, but without blocking the main thread.</p>

<p>Bluejay will call your completion block on the main thread when everything finishes without an error, or if any one of the operations in the background task has failed.</p>

<p>Here&rsquo;s a made-up example in trying get both user and admin access to a Bluetooth device using the same password:</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">isUserAuthenticated</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">var</span> <span class="nv">isAdminAuthenticated</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">bluejay</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="nv">backgroundTask</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">peripheral</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Bool</span><span class="p">)</span> <span class="k">in</span>
    <span class="c1">// 1. No need to perform any Bluetooth tasks if there's no password to try.</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="n">enteredPassword</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nf">return</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 2. Flush auth characteristics in case they are still broadcasting unwanted data.</span>
    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">flushListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">userAuth</span><span class="p">,</span> <span class="nv">nonZeroTimeout</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Flushed buffered data on the user auth characteristic."</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">flushListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">adminAuth</span><span class="p">,</span> <span class="nv">nonZeroTimeout</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Flushed buffered data on the admin auth characteristic."</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1">// 3. Sanity checks, making sure the characteristics are not broadcasting anymore.</span>
    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">endListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">userAuth</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">endListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">adminAuth</span><span class="p">)</span>

    <span class="c1">// 4. Attempt authentication.</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">passwordData</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Begin authentication..."</span><span class="p">)</span>

        <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">writeAndListen</span><span class="p">(</span>
            <span class="nv">writeTo</span><span class="p">:</span> <span class="n">userAuth</span><span class="p">,</span>
            <span class="nv">value</span><span class="p">:</span> <span class="n">passwordData</span><span class="p">,</span>
            <span class="nv">listenTo</span><span class="p">:</span> <span class="n">userAuth</span><span class="p">,</span>
            <span class="nv">timeoutInSeconds</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
            <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">response</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ListenAction</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">responseCode</span> <span class="o">=</span> <span class="kt">AuthResponse</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">isUserAuthenticated</span> <span class="o">=</span> <span class="n">responseCode</span> <span class="o">==</span> <span class="o">.</span><span class="n">success</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="o">.</span><span class="n">done</span>
        <span class="p">})</span>

        <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">writeAndListen</span><span class="p">(</span>
            <span class="nv">writeTo</span><span class="p">:</span> <span class="n">adminAuth</span><span class="p">,</span>
            <span class="nv">value</span><span class="p">:</span> <span class="n">passwordData</span><span class="p">,</span>
            <span class="nv">listenTo</span><span class="p">:</span> <span class="n">adminAuth</span><span class="p">,</span>
            <span class="nv">timeoutInSeconds</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
            <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">response</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ListenAction</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">responseCode</span> <span class="o">=</span> <span class="kt">AuthResponse</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">isAdminAuthenticated</span> <span class="o">=</span> <span class="n">responseCode</span> <span class="o">==</span> <span class="o">.</span><span class="n">success</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="o">.</span><span class="n">done</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">// 5. Return results of authentication.</span>
    <span class="nf">return</span> <span class="p">(</span><span class="n">isUserAuthenticated</span><span class="p">,</span> <span class="n">isAdminAuthenticated</span><span class="p">)</span>
<span class="p">},</span> <span class="nv">completionOnMainThread</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">authResults</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Is user authenticated: </span><span class="se">\(</span><span class="n">authResults</span><span class="o">.</span><span class="mi">0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Is admin authenticated: </span><span class="se">\(</span><span class="n">authResults</span><span class="o">.</span><span class="mi">1</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Background task failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p><strong>Important:</strong></p>

<p>While Bluejay will not crash because it has built in error handling that will inform you of the following violations, these rules are are still worth calling out:</p>

<ol>
<li><strong>Do not</strong> call any regular <code>read/write/listen</code> functions inside the <code>backgroundTask</code> block. Use the <code><a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a></code> provided to you and its <code>read/write/listen</code> API instead.</li>
<li>Regular <code>read/write/listen</code> calls outside of the <code>backgroundTask</code> block will <strong>also not work</strong> when a background task is still running.</li>
</ol>

<p>Note that because the <code>backgroundTask</code> block is running on a background thread, you need to be careful about accessing any global or captured data inside that block for thread safety reasons, like you would with any GCD or OperationQueue task. To help with this, use <code>run(userData:backgroundTask:completionOnMainThread:)</code> to pass an object you wish to have thread-safe access to while working inside the background task.</p>
<h2 id='background-restoration' class='heading'>Background Restoration</h2>

<p><a href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html">CoreBluetooth allows apps to continue processing active Bluetooth operations when it is backgrounded or even when it is evicted from memory</a>. In Bluejay, we refer to this feature and behaviour as <q>background restoration</q>. For examples, a pending connect request that finishes, or a subscribed characteristic that fires a notification, can cause the system to wake or restart the app in the background. This can, for example, allow syncing data from a device without requiring the user to launch the app.</p>

<p>In order to support background Bluetooth, there are two steps to take:</p>

<ol>
<li>Give you app permission to use Bluetooth in the background</li>
<li>Implement and handle state restoration</li>
</ol>
<h3 id='background-permission' class='heading'>Background Permission</h3>

<p>This is the easy step. Just turn on the <strong>Background Modes</strong> capability in your Xcode project with <strong>Uses Bluetooth LE accessories</strong> enabled.</p>
<h3 id='state-restoration' class='heading'>State Restoration</h3>

<p>Bluejay already handles much of the gnarly state restoration implementation for you. However, there are still a few things you need to do to help Bluejay help you:</p>

<ol>
<li>Create a background restoration configuration with a restore identifier</li>
<li>Always start your Bluejay instance in your AppDelegate&rsquo;s <code>application(_:didFinishLaunchingWithOptions:)</code></li>
<li>Always pass Bluejay the <code>launchOptions</code></li>
<li>Setup a <code><a href="Protocols/BackgroundRestorer.html">BackgroundRestorer</a></code> and a <code><a href="Protocols/ListenRestorer.html">ListenRestorer</a></code> to handle restoration results</li>
</ol>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Bluejay</span>
<span class="kd">import</span> <span class="kt">UIKit</span>

<span class="k">let</span> <span class="nv">bluejay</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="p">()</span>

<span class="kd">@UIApplicationMain</span>
<span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span><span class="p">,</span> <span class="kt">UIApplicationDelegate</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">window</span><span class="p">:</span> <span class="kt">UIWindow</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplication</span><span class="o">.</span><span class="kt">LaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// Override point for customization after application launch.</span>
        <span class="k">let</span> <span class="nv">backgroundRestoreConfig</span> <span class="o">=</span> <span class="kt">BackgroundRestoreConfig</span><span class="p">(</span>
            <span class="nv">restoreIdentifier</span><span class="p">:</span> <span class="s">"com.steamclock.bluejayHeartSensorDemo"</span><span class="p">,</span>
            <span class="nv">backgroundRestorer</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span>
            <span class="nv">listenRestorer</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span>
            <span class="nv">launchOptions</span><span class="p">:</span> <span class="n">launchOptions</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">backgroundRestoreMode</span> <span class="o">=</span> <span class="kt">BackgroundRestoreMode</span><span class="o">.</span><span class="nf">enable</span><span class="p">(</span><span class="n">backgroundRestoreConfig</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">options</span> <span class="o">=</span> <span class="kt">StartOptions</span><span class="p">(</span>
          <span class="nv">enableBluetoothAlert</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nv">backgroundRestore</span><span class="p">:</span> <span class="n">backgroundRestoreMode</span><span class="p">)</span>

        <span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">mode</span><span class="p">:</span> <span class="o">.</span><span class="nf">new</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">BackgroundRestorer</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">didRestoreConnection</span><span class="p">(</span>
      <span class="n">to</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">BackgroundRestoreCompletion</span> <span class="p">{</span>
        <span class="c1">// Opportunity to perform syncing related logic here.</span>
        <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didFailToRestoreConnection</span><span class="p">(</span>
      <span class="n">to</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">BackgroundRestoreCompletion</span> <span class="p">{</span>
        <span class="c1">// Opportunity to perform cleanup or error handling logic here.</span>
        <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">ListenRestorer</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">didReceiveUnhandledListen</span><span class="p">(</span>
      <span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">,</span>
      <span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">,</span>
      <span class="n">with</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">ListenRestoreAction</span> <span class="p">{</span>
        <span class="c1">// Re-install or defer installing a callback to a notifying characteristic.</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">promiseRestoration</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>While Bluejay has simplified background restoration to just a few initialization rules and two protocols, it can still be difficult to get right. Please contact us if you have any questions</p>
<h3 id='listen-restoration' class='heading'>Listen Restoration</h3>

<p>If you app is evicted from memory, you lose all your listen callbacks as well. Yet, the Bluetooth device can still be broadcasting on the characteristics you were listening to. Listen restoration gives you an opportunity to restore and to respond to that notification when your app is restored in the background.</p>

<p>If you need to re-install a listen, simply call <code>listen</code> again as you normally would when setting up a new listen inside <code>didReceiveUnhandledListen(from:on:with:)</code> before returning <code>.promiseRestoration</code>. Otherwise, return <code>.stopListen</code> to ask Bluejay to turn off notification on that characteristic.</p>
<pre class="highlight swift"><code><span class="cm">/**
 * Available actions to take on an unhandled listen event from background restoration.
 */</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ListenRestoreAction</span> <span class="p">{</span>
    <span class="c1">/// Bluejay will continue to receive but do nothing with the incoming listen events until a new listener is installed.</span>
    <span class="k">case</span> <span class="n">promiseRestoration</span>
    <span class="c1">/// Bluejay will attempt to turn off notifications on the peripheral.</span>
    <span class="k">case</span> <span class="n">stopListen</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">ListenRestorer</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">didReceiveUnhandledListen</span><span class="p">(</span>
      <span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">,</span>
      <span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">,</span>
      <span class="n">with</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">ListenRestoreAction</span> <span class="p">{</span>
        <span class="c1">// Re-install or defer installing a callback to a notifying characteristic.</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">promiseRestoration</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id='advanced-usage' class='heading'>Advanced Usage</h2>

<p>The following section will demonstrate a few advanced usage of Bluejay.</p>
<h3 id='write-and-assemble' class='heading'>Write and Assemble</h3>

<p>One of the Bluetooth modules we&rsquo;ve worked with doesn&rsquo;t always send back the entire data in one packet, even if the data is smaller than either the software&rsquo;s or hardware&rsquo;s maximum packet size. To handle incoming data that can be broken up into an unknown number of packets, we&rsquo;ve added the <code>writeAndAssemble</code> function that is very similar to <code>writeAndListen</code> on the <code><a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a></code>. Therefore, at least for now, this is currently only supported when using the <a href="#background-task">background task</a>.</p>

<p>When using <code>writeAndAssemble</code>, we still expect you to know the total size of the data you are receiving, but Bluejay will keep listening and receiving packets until the expected size is reached before trying to <a href="#deserialization-and-serialization">deserialize</a> the data into the object you need.</p>

<p>You can also specify a timeout in case something hangs or takes abnormally long.</p>

<p>Here is an example writing a request for a value to a Bluetooth module, so that it can return the value we want via a notification on a characteristic. And of course, we&rsquo;re not sure and have no control over how many packets the module will send back.</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">writeAndAssemble</span><span class="p">(</span>
    <span class="nv">writeTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoTX</span><span class="p">,</span>
    <span class="nv">value</span><span class="p">:</span> <span class="kt">ReadRequest</span><span class="p">(</span><span class="nv">handle</span><span class="p">:</span> <span class="kt">Registers</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">firmwareVersion</span><span class="p">),</span>
    <span class="nv">listenTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoRX</span><span class="p">,</span>
    <span class="nv">expectedLength</span><span class="p">:</span> <span class="kt">FirmwareVersion</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
    <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">firmwareVersion</span><span class="p">:</span> <span class="kt">FirmwareVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ListenAction</span> <span class="k">in</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">firmwareVersion</span><span class="o">.</span><span class="n">string</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">done</span>
<span class="p">})</span>
</code></pre>
<h3 id='flush-listen' class='heading'>Flush Listen</h3>

<p>Some Bluetooth modules will pause sending data when it loses connection to your app, then resume sending the same set of data from where it left off when the connection is re-established. This isn&rsquo;t an issue most of the time, except for Bluetooth modules that do overload one characteristic with multiple purposes and values.</p>

<p>For example, you might have to re-authenticate the user when the app is re-opened. But if authentication requires listening to the same characteristic where an incomplete data set from a previous request is still being sent, then you will be getting back unexpected values and most likely crash when trying to <a href="#deserialization-and-serialization">deserialize</a> authentication related objects.</p>

<p>To handle this, it is often a good idea to flush a notifiable characteristic before starting a critical operation. This is also only available on the <code><a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a></code> when working within the <a href="#background-task">background task</a></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">flushListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">auth</span><span class="p">,</span> <span class="nv">nonZeroTimeout</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Flushed buffered data on the auth characteristic."</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>

<p>The <code>nonZeroTimeout</code> specifies the duration of the <strong>absence of incoming data</strong> needed to predict that the flush is most likely completed. In the above example, it is not that the flush will come to a hard stop after 3 seconds, but rather will only stop if Bluejay doesn&rsquo;t have any data to flush after waiting for 3 seconds. It will continue to flush for as long as there is incoming data.</p>
<h3 id='corebluetooth-migration' class='heading'>CoreBluetooth Migration</h3>

<p>If you want to start Bluejay with a pre-existing CoreBluetooth stack, you can do so by specifying <code>.use</code> in the start mode instead of <code>.new</code> when calling the <code>start</code> function.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">mode</span><span class="p">:</span> <span class="o">.</span><span class="nf">use</span><span class="p">(</span><span class="nv">manager</span><span class="p">:</span> <span class="n">anotherManager</span><span class="p">,</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="n">alreadyConnectedPeripheral</span><span class="p">))</span>
</code></pre>

<p>You can also transfer Bluejay&rsquo;s CoreBluetooth stack to another Bluetooth library or your own using this function:</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">func</span> <span class="nf">stopAndExtractBluetoothState</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="nv">manager</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">?)</span>
</code></pre>

<p>Finally, you can check whether Bluejay has been started or stopped using the <code>hasStarted</code> property.</p>
<h3 id='monitor-peripheral-services' class='heading'>Monitor Peripheral Services</h3>

<p>Some peripherals can add or remove services while it&rsquo;s being used, and Bluejay provides a basic way to react to this. See <strong>BluejayHeartSensorDemo</strong> and <strong>DittojayHeartSensorDemo</strong> in the project for more examples.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">serviceObserver</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
</code></pre>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">didModifyServices</span><span class="p">(</span>
  <span class="n">from</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">PeripheralIdentifier</span><span class="p">,</span>
  <span class="nv">invalidatedServices</span><span class="p">:</span> <span class="p">[</span><span class="kt">ServiceIdentifier</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">invalidatedServices</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="n">invalidatedServiceIdentifier</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="k">in</span>
        <span class="n">invalidatedServiceIdentifier</span> <span class="o">==</span> <span class="n">chirpCharacteristic</span><span class="o">.</span><span class="n">service</span>
    <span class="p">})</span> <span class="p">{</span>
        <span class="nf">endListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">chirpCharacteristic</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">invalidatedServices</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
        <span class="nf">listen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">chirpCharacteristic</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><strong>Notes from Apple:</strong></p>

<blockquote>
<p>If you previously discovered any of the services that have changed, they are provided in the invalidatedServices parameter and can no longer be used. You can use the discoverServices: method to discover any new services that have been added to the peripheralâ€™s database or to find out whether any of the invalidated services that you were using (and want to continue using) have been added back to a different location in the peripheralâ€™s database.</p>
</blockquote>
<h2 id='api-documentation' class='heading'>API Documentation</h2>

<p>We have more <a href="https://steamclock.github.io/bluejay/index.html">in-depth API documentation for Bluejay</a> using inline documentation and Jazzy.</p>

          </section>
        </section>
        <section id="footer">
          <p>Copyright Â© 2017 Steamclock Software. All rights reserved.</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy â™ªâ™« v0.9.5</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
